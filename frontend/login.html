<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetterDoctor - Iniciar Sesi√≥n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ========================================
           SISTEMA DE DISE√ëO BETTERDOCTOR v2.0
           ======================================== */
        :root {
            /* Colores principales */
            --primary: #0891b2;
            --primary-dark: #0e7490;
            --primary-light: #22d3ee;
            --primary-bg: #ecfeff;
            
            /* Colores secundarios */
            --secondary: #10b981;
            --secondary-dark: #059669;
            --secondary-light: #34d399;
            
            /* Estados */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            
            /* Neutros */
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            
            /* Sombras */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            
            /* Bordes */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 50%, var(--secondary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }

        /* Elementos decorativos de fondo */
        body::before,
        body::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.03);
        }
        body::before {
            width: 800px;
            height: 800px;
            top: -400px;
            left: -200px;
        }
        body::after {
            width: 600px;
            height: 600px;
            bottom: -300px;
            right: -150px;
        }

        .login-container {
            display: flex;
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-2xl);
            overflow: hidden;
            max-width: 1100px;
            width: 100%;
            min-height: 650px;
            position: relative;
            z-index: 1;
        }

        /* Panel izquierdo - Branding */
        .brand-panel {
            flex: 1.2;
            background: linear-gradient(160deg, var(--primary) 0%, var(--primary-dark) 60%, var(--secondary-dark) 100%);
            padding: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .brand-panel::before {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
            top: -100px;
            right: -100px;
        }

        .brand-panel::after {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.03);
            border-radius: 50%;
            bottom: -80px;
            left: -80px;
        }

        .brand-content {
            position: relative;
            z-index: 1;
            color: white;
        }

        .brand-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .brand-icon {
            width: 70px;
            height: 70px;
            background: var(--white);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .brand-name {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .brand-tagline {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 3rem;
            font-weight: 400;
        }

        .features-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .feature-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: var(--radius-md);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .feature-item:hover {
            background: rgba(255,255,255,0.15);
            transform: translateX(5px);
        }

        .feature-icon {
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .feature-text h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .feature-text p {
            font-size: 0.8rem;
            opacity: 0.8;
            line-height: 1.4;
        }

        /* Panel derecho - Login */
        .login-panel {
            flex: 1;
            padding: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: var(--white);
        }

        .login-header {
            margin-bottom: 2rem;
        }

        .login-header h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: var(--gray-500);
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.1rem;
            color: var(--gray-400);
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 3rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-family: inherit;
            color: var(--gray-800);
            background: var(--gray-50);
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 4px rgba(8, 145, 178, 0.1);
        }

        .form-input::placeholder {
            color: var(--gray-400);
        }

        .btn-login {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 1.75rem 0;
            color: var(--gray-400);
            font-size: 0.8rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--gray-200);
        }

        .divider span {
            padding: 0 1rem;
        }

        .demo-section h4 {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .demo-users {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .demo-btn {
            padding: 0.75rem 0.875rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            font-family: inherit;
        }

        .demo-btn:hover {
            border-color: var(--primary);
            background: var(--primary-bg);
        }

        .demo-btn .role {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.25rem;
        }

        .demo-btn .credentials {
            font-size: 0.7rem;
            color: var(--gray-500);
        }

        .demo-btn.admin { border-color: #fcd34d; background: #fffbeb; }
        .demo-btn.admin:hover { border-color: #f59e0b; }
        .demo-btn.vet { border-color: var(--primary-light); background: var(--primary-bg); }
        .demo-btn.vet:hover { border-color: var(--primary); }
        .demo-btn.recep { border-color: #a5b4fc; background: #eef2ff; }
        .demo-btn.recep:hover { border-color: #6366f1; }
        .demo-btn.inv { border-color: #86efac; background: #f0fdf4; }
        .demo-btn.inv:hover { border-color: var(--secondary); }

        /* Responsive */
        @media (max-width: 900px) {
            .login-container {
                flex-direction: column;
                max-width: 500px;
            }
            .brand-panel {
                padding: 2rem;
            }
            .features-list {
                display: none;
            }
            .brand-name {
                font-size: 2rem;
            }
        }

        @media (max-width: 500px) {
            .demo-users {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <!-- Panel Izquierdo - Branding -->
        <div class="brand-panel">
            <div class="brand-content">
                <div class="brand-logo">
                    <div class="brand-icon">üè•</div>
                    <span class="brand-name">BetterDoctor</span>
                </div>
                <p class="brand-tagline">Sistema Integral de Gesti√≥n Veterinaria</p>
                
                <div class="features-list">
                    <div class="feature-item">
                        <div class="feature-icon">üìã</div>
                        <div class="feature-text">
                            <h3>Gesti√≥n de Pacientes</h3>
                            <p>Historial cl√≠nico completo y seguimiento de mascotas</p>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üî¨</div>
                        <div class="feature-text">
                            <h3>Diagn√≥stico Inteligente</h3>
                            <p>Sugerencias basadas en s√≠ntomas con IA</p>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üì¶</div>
                        <div class="feature-text">
                            <h3>Control de Inventario</h3>
                            <p>Gesti√≥n de medicamentos y alertas de stock</p>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">ü§ñ</div>
                        <div class="feature-text">
                            <h3>Chatbot de Atenci√≥n</h3>
                            <p>Triage autom√°tico y agendamiento 24/7</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Derecho - Login -->
        <div class="login-panel">
            <div class="login-header">
                <h2>Bienvenido</h2>
                <p>Ingresa tus credenciales para continuar</p>
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Usuario</label>
                    <div class="input-wrapper">
                        <span class="input-icon">üë§</span>
                        <input type="text" id="usuario" class="form-input" placeholder="Ingresa tu usuario" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <div class="input-wrapper">
                        <span class="input-icon">üîí</span>
                        <input type="password" id="password" class="form-input" placeholder="Ingresa tu contrase√±a" required>
                    </div>
                </div>

                <button type="submit" class="btn-login">Iniciar Sesi√≥n</button>
            </form>

            <div class="divider"><span>Usuarios de demostraci√≥n</span></div>

            <div class="demo-section">
                <h4>üëÜ Clic para autocompletar</h4>
                <div class="demo-users">
                    <button type="button" class="demo-btn admin" onclick="fillDemo('admin', 'admin2024')">
                        <div class="role">üëë Super Admin</div>
                        <div class="credentials">admin / admin2024</div>
                    </button>
                    <button type="button" class="demo-btn vet" onclick="fillDemo('dr.martinez', 'vet2024')">
                        <div class="role">ü©∫ Veterinario</div>
                        <div class="credentials">dr.martinez / vet2024</div>
                    </button>
                    <button type="button" class="demo-btn recep" onclick="fillDemo('recepcion', 'recep2024')">
                        <div class="role">üìã Recepcionista</div>
                        <div class="credentials">recepcion / recep2024</div>
                    </button>
                    <button type="button" class="demo-btn inv" onclick="fillDemo('inventario', 'inv2024')">
                        <div class="role">üì¶ Inventario</div>
                        <div class="credentials">inventario / inv2024</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== CHATBOX WIDGET ========== -->
    <div id="chatbox-container" class="chatbox-container">
        <!-- Bot√≥n flotante -->
        <button id="chatbox-toggle" class="chatbox-toggle" onclick="toggleChatbox()">
            <span class="chat-icon">üí¨</span>
            <span class="close-icon">‚úï</span>
        </button>
        
        <!-- Ventana de chat -->
        <div id="chatbox-window" class="chatbox-window">
            <div class="chatbox-header">
                <div class="chatbox-header-info">
                    <div class="chatbox-avatar">üêæ</div>
                    <div class="chatbox-title">
                        <h4>Asistente BetterDoctor</h4>
                        <span class="chatbox-status">‚óè En l√≠nea</span>
                    </div>
                </div>
                <button class="chatbox-close" onclick="toggleChatbox()">‚úï</button>
            </div>
            
            <div id="chatbox-messages" class="chatbox-messages">
                <div class="chat-message bot">
                    <div class="message-avatar">üêæ</div>
                    <div class="message-content">
                        <p>¬°Hola! üëã Soy el asistente virtual de BetterDoctor.</p>
                        <p>Puedo ayudarte con:</p>
                        <ul>
                            <li>üîç Consultar disponibilidad de productos</li>
                            <li>ü©∫ Evaluar s√≠ntomas de tu mascota</li>
                            <li>üìÖ Agendar citas veterinarias</li>
                        </ul>
                        <p>¬øEn qu√© puedo ayudarte hoy?</p>
                    </div>
                </div>
            </div>
            
            <div class="chatbox-quick-actions">
                <button onclick="sendQuickMessage('¬øTienen antiparasitarios disponibles?')">üíä Medicamentos</button>
                <button onclick="sendQuickMessage('Mi mascota tiene v√≥mitos y diarrea')">ü©∫ S√≠ntomas</button>
                <button onclick="sendQuickMessage('Quiero agendar una cita')">üìÖ Agendar cita</button>
            </div>
            
            <div class="chatbox-input-area">
                <input type="text" id="chatbox-input" placeholder="Escribe tu mensaje..." onkeypress="handleChatKeypress(event)">
                <button id="chatbox-send" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <style>
        /* ========== CHATBOX STYLES ========== */
        .chatbox-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
            font-family: 'Inter', sans-serif;
        }

        .chatbox-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(8, 145, 178, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .chatbox-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(8, 145, 178, 0.5);
        }

        .chatbox-toggle .chat-icon,
        .chatbox-toggle .close-icon {
            font-size: 24px;
            position: absolute;
            transition: all 0.3s ease;
        }

        .chatbox-toggle .close-icon {
            opacity: 0;
            transform: rotate(-90deg);
            color: white;
            font-size: 20px;
        }

        .chatbox-container.open .chatbox-toggle .chat-icon {
            opacity: 0;
            transform: rotate(90deg);
        }

        .chatbox-container.open .chatbox-toggle .close-icon {
            opacity: 1;
            transform: rotate(0);
        }

        .chatbox-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 380px;
            height: 520px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s ease;
        }

        .chatbox-container.open .chatbox-window {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .chatbox-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chatbox-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chatbox-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .chatbox-title h4 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
        }

        .chatbox-status {
            font-size: 12px;
            opacity: 0.9;
            color: #4ade80;
        }

        .chatbox-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .chatbox-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chatbox-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: #f8fafc;
        }

        .chat-message {
            display: flex;
            gap: 10px;
            max-width: 90%;
            animation: messageIn 0.3s ease;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.bot {
            align-self: flex-start;
        }

        .chat-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .chat-message.user .message-avatar {
            background: var(--secondary);
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 16px;
            border-top-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chat-message.user .message-content {
            background: var(--primary);
            color: white;
            border-radius: 16px;
            border-top-right-radius: 4px;
        }

        .message-content p {
            margin: 0 0 8px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul {
            margin: 8px 0;
            padding-left: 20px;
            font-size: 13px;
        }

        .message-content li {
            margin: 4px 0;
        }

        .chatbox-quick-actions {
            padding: 8px 16px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .chatbox-quick-actions button {
            padding: 6px 12px;
            border: 1px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .chatbox-quick-actions button:hover {
            background: var(--primary);
            color: white;
        }

        .chatbox-input-area {
            padding: 16px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        #chatbox-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        #chatbox-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        #chatbox-send {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        #chatbox-send:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        #chatbox-send svg {
            width: 20px;
            height: 20px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--gray-400);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .chatbox-window {
                width: calc(100vw - 32px);
                height: calc(100vh - 120px);
                bottom: 72px;
                right: -8px;
            }
        }
    </style>

    <script>
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000' 
            : window.location.origin;

        // ========== N8N CONFIGURATION ==========
        const N8N_WEBHOOK_URL = 'http://localhost:5678/webhook/e1ad9a32-b091-483c-a80e-19200cbe1f38/chat';
        const USE_N8N = window.location.hostname === 'localhost'; // Solo usar n8n en local
        let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        // ========== CHATBOX STATE ==========
        let chatContext = {
            lastIntent: null,
            pacienteNombre: null,
            pacienteEspecie: null,
            tutorNombre: null,
            tutorTelefono: null,
            sintomas: [],
            waitingFor: null
        };

        function toggleChatbox() {
            const container = document.getElementById('chatbox-container');
            container.classList.toggle('open');
            if (container.classList.contains('open')) {
                document.getElementById('chatbox-input').focus();
            }
        }

        function handleChatKeypress(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        }

        function sendQuickMessage(text) {
            document.getElementById('chatbox-input').value = text;
            sendMessage();
        }

        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chatbox-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'user' : 'bot'}`;
            
            const avatar = isUser ? 'üë§' : 'üêæ';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            const messagesContainer = document.getElementById('chatbox-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message bot';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">üêæ</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('chatbox-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage(`<p>${message}</p>`, true);
            input.value = '';
            
            showTyping();
            
            try {
                const response = await processMessage(message);
                hideTyping();
                addMessage(response);
            } catch (error) {
                hideTyping();
                addMessage('<p>Lo siento, hubo un error. Por favor intenta de nuevo.</p>');
            }
        }

        async function processMessage(message) {
            // ========== INTENTAR N8N PRIMERO (solo en localhost) ==========
            if (USE_N8N) {
                try {
                    const n8nResponse = await sendToN8N(message);
                    if (n8nResponse) {
                        return n8nResponse;
                    }
                } catch (error) {
                    console.log('n8n no disponible, usando l√≥gica local:', error.message);
                }
            }
            
            // ========== L√ìGICA LOCAL (fallback o producci√≥n) ==========
            const msgLower = message.toLowerCase();
            
            // Detectar si est√° esperando informaci√≥n espec√≠fica
            if (chatContext.waitingFor) {
                return await handleWaitingResponse(message);
            }
            
            // Detectar intenci√≥n
            if (containsAny(msgLower, ['producto', 'medicamento', 'tienen', 'hay', 'stock', 'disponible', 'antiparasitario', 'vacuna', 'simparica', 'nexgard', 'bravecto', 'alimento', 'comida'])) {
                return await handleInventoryQuery(message);
            }
            
            if (containsAny(msgLower, ['sintoma', 'enfermo', 'vomit', 'diarrea', 'tos', 'fiebre', 'no come', 'decaido', 'dolor', 'sangre', 'herida', 'cojea', 'rascarse', 'picazon'])) {
                return await handleSymptomQuery(message);
            }
            
            if (containsAny(msgLower, ['cita', 'agendar', 'reservar', 'turno', 'consulta', 'hora', 'atencion', 'veterinario'])) {
                return handleAppointmentStart();
            }
            
            if (containsAny(msgLower, ['hola', 'buenos', 'buenas', 'hey', 'hi'])) {
                return `<p>¬°Hola! üëã ¬øEn qu√© puedo ayudarte hoy?</p>
                        <p>Puedo asistirte con:</p>
                        <ul>
                            <li>üîç Disponibilidad de productos</li>
                            <li>ü©∫ Evaluaci√≥n de s√≠ntomas</li>
                            <li>üìÖ Agendar citas</li>
                        </ul>`;
            }
            
            if (containsAny(msgLower, ['gracias', 'thanks', 'genial', 'perfecto'])) {
                return `<p>¬°De nada! üòä ¬øHay algo m√°s en lo que pueda ayudarte?</p>`;
            }
            
            // Respuesta por defecto
            return `<p>No estoy seguro de entender tu consulta. ü§î</p>
                    <p>Puedo ayudarte con:</p>
                    <ul>
                        <li>üì¶ "¬øTienen Simparica?" - para consultar productos</li>
                        <li>ü©∫ "Mi perro tiene v√≥mitos" - para evaluar s√≠ntomas</li>
                        <li>üìÖ "Quiero agendar una cita" - para reservar</li>
                    </ul>`;
        }

        // ========== N8N INTEGRATION ==========
        async function sendToN8N(message) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
            
            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatInput: message,
                        sessionId: sessionId,
                        action: 'sendMessage'
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // n8n puede devolver la respuesta en diferentes formatos
                let botResponse = data.output || data.response || data.text || data.message || data;
                
                // Si es un string, convertir a HTML
                if (typeof botResponse === 'string') {
                    // Convertir saltos de l√≠nea a <br> y envolver en <p>
                    botResponse = botResponse
                        .split('\n\n')
                        .map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`)
                        .join('');
                }
                
                return botResponse;
                
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('Error al conectar con n8n:', error);
                throw error;
            }
        }

        function containsAny(text, keywords) {
            return keywords.some(keyword => text.includes(keyword));
        }

        async function handleInventoryQuery(message) {
            // Extraer producto de la consulta
            const palabras = message.toLowerCase().split(/\s+/);
            const stopWords = ['tienen', 'hay', 'tienes', 'el', 'la', 'un', 'una', 'de', 'para', 'que', 'en', 'disponible', 'stock', 'producto', 'medicamento', 'busco', 'necesito', 'quiero'];
            const producto = palabras.filter(p => !stopWords.includes(p) && p.length > 2).join(' ');
            
            if (!producto) {
                return `<p>¬øQu√© producto te gustar√≠a consultar? üîç</p>
                        <p>Por ejemplo: antiparasitarios, vacunas, alimentos, etc.</p>`;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/bot/inventario?q=${encodeURIComponent(producto)}`);
                const data = await response.json();
                
                if (data.encontrados && data.encontrados > 0) {
                    let html = `<p>‚úÖ Encontr√© <strong>${data.encontrados}</strong> producto(s) relacionados:</p><ul>`;
                    
                    data.productos.slice(0, 5).forEach(prod => {
                        const disponible = prod.stock > 0;
                        const icon = disponible ? '‚úÖ' : '‚ùå';
                        html += `<li>${icon} <strong>${prod.nombre}</strong> - ${disponible ? 'Disponible' : 'Sin stock'}</li>`;
                    });
                    
                    html += '</ul>';
                    
                    if (data.encontrados > 5) {
                        html += `<p><em>...y ${data.encontrados - 5} m√°s</em></p>`;
                    }
                    
                    html += `<p>¬øTe gustar√≠a saber m√°s detalles o agendar una cita? üìÖ</p>`;
                    return html;
                } else {
                    return `<p>No encontr√© productos con "${producto}" üòî</p>
                            <p>¬øPodr√≠as ser m√°s espec√≠fico o probar con otro nombre?</p>`;
                }
            } catch (error) {
                console.error('Error consultando inventario:', error);
                return `<p>Hubo un problema al consultar el inventario. Por favor intenta de nuevo.</p>`;
            }
        }

        async function handleSymptomQuery(message) {
            // Extraer s√≠ntomas del mensaje
            const sintomasDetectados = [];
            const sintomasKeywords = {
                'vomito': ['vomit', 'v√≥mito', 'devuelve', 'arcadas'],
                'diarrea': ['diarrea', 'heces', 'deposiciones', 'liquidas'],
                'fiebre': ['fiebre', 'caliente', 'temperatura'],
                'letargia': ['decaido', 'cansado', 'no se mueve', 'debil', 'apatico'],
                'inapetencia': ['no come', 'sin apetito', 'no quiere comer', 'dej√≥ de comer'],
                'tos': ['tos', 'tose', 'tosiendo'],
                'dolor': ['dolor', 'queja', 'llora', 'gime', 'aulla'],
                'cojera': ['cojea', 'cojera', 'no apoya', 'pata'],
                'picazon': ['rasca', 'picazon', 'comez√≥n', 'rascarse'],
                'sangrado': ['sangre', 'sangrado', 'hemorragia']
            };
            
            const msgLower = message.toLowerCase();
            for (const [sintoma, keywords] of Object.entries(sintomasKeywords)) {
                if (keywords.some(k => msgLower.includes(k))) {
                    sintomasDetectados.push(sintoma);
                }
            }
            
            if (sintomasDetectados.length === 0) {
                chatContext.waitingFor = 'sintomas';
                return `<p>Entiendo que tu mascota no se siente bien üòü</p>
                        <p>¬øPodr√≠as describirme los s√≠ntomas espec√≠ficos que presenta?</p>
                        <p><em>Por ejemplo: v√≥mitos, diarrea, no come, est√° deca√≠do, etc.</em></p>`;
            }
            
            chatContext.sintomas = sintomasDetectados;
            
            try {
                const response = await fetch(`${API_URL}/api/bot/diagnostico`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sintomas: sintomasDetectados })
                });
                
                const data = await response.json();
                
                let html = `<p>Bas√°ndome en los s√≠ntomas descritos (<strong>${sintomasDetectados.join(', ')}</strong>), aqu√≠ est√° mi evaluaci√≥n:</p>`;
                
                if (data.nivel_urgencia === 'alto') {
                    html += `<p style="color: #ef4444; font-weight: 600;">üö® URGENCIA ALTA - Te recomiendo acudir a la veterinaria lo antes posible.</p>`;
                } else if (data.nivel_urgencia === 'medio') {
                    html += `<p style="color: #f59e0b; font-weight: 600;">‚ö†Ô∏è URGENCIA MEDIA - Es importante una consulta pronto.</p>`;
                } else {
                    html += `<p style="color: #10b981;">‚úÖ No parece ser una emergencia, pero siempre es bueno consultar.</p>`;
                }
                
                if (data.posibles_diagnosticos && data.posibles_diagnosticos.length > 0) {
                    html += `<p>Posibles condiciones a evaluar:</p><ul>`;
                    data.posibles_diagnosticos.slice(0, 3).forEach(dx => {
                        html += `<li>${dx.nombre}</li>`;
                    });
                    html += '</ul>';
                }
                
                html += `<p><strong>¬øTe gustar√≠a agendar una cita ahora?</strong> üìÖ</p>`;
                
                chatContext.lastIntent = 'sintomas';
                return html;
                
            } catch (error) {
                console.error('Error en diagn√≥stico:', error);
                return `<p>No pude procesar los s√≠ntomas. Sin embargo, si tu mascota presenta estos s√≠ntomas, te recomiendo consultar con un veterinario.</p>
                        <p>¬øQuieres que te ayude a agendar una cita? üìÖ</p>`;
            }
        }

        function handleAppointmentStart() {
            chatContext.waitingFor = 'nombre_mascota';
            chatContext.lastIntent = 'cita';
            
            return `<p>¬°Perfecto! Vamos a agendar tu cita üìÖ</p>
                    <p>Por favor, dime el <strong>nombre de tu mascota</strong>:</p>`;
        }

        async function handleWaitingResponse(message) {
            const waiting = chatContext.waitingFor;
            
            if (waiting === 'sintomas') {
                chatContext.waitingFor = null;
                return await handleSymptomQuery(message);
            }
            
            if (waiting === 'nombre_mascota') {
                chatContext.pacienteNombre = message.trim();
                chatContext.waitingFor = 'especie';
                return `<p>Gracias. <strong>${chatContext.pacienteNombre}</strong> üêæ</p>
                        <p>¬øQu√© tipo de mascota es? (perro, gato, otro)</p>`;
            }
            
            if (waiting === 'especie') {
                chatContext.pacienteEspecie = message.trim().toLowerCase();
                chatContext.waitingFor = 'nombre_tutor';
                return `<p>Entendido, un <strong>${chatContext.pacienteEspecie}</strong>.</p>
                        <p>¬øCu√°l es tu nombre completo?</p>`;
            }
            
            if (waiting === 'nombre_tutor') {
                chatContext.tutorNombre = message.trim();
                chatContext.waitingFor = 'telefono';
                return `<p>Gracias, <strong>${chatContext.tutorNombre}</strong>.</p>
                        <p>¬øCu√°l es tu n√∫mero de tel√©fono de contacto? üì±</p>`;
            }
            
            if (waiting === 'telefono') {
                chatContext.tutorTelefono = message.trim();
                chatContext.waitingFor = null;
                
                // Crear la cita
                return await createAppointment();
            }
            
            return `<p>Lo siento, no entend√≠. ¬øPodr√≠as repetir?</p>`;
        }

        async function createAppointment() {
            // Determinar nivel de urgencia basado en s√≠ntomas
            const sintomasTexto = chatContext.sintomas.join(' ');
            let urgencia = 'normal';
            
            if (containsAny(sintomasTexto, ['sangrado', 'convulsion', 'envenenamiento', 'atropello'])) {
                urgencia = 'emergencia';
            } else if (containsAny(sintomasTexto, ['vomito', 'diarrea', 'fiebre', 'dolor'])) {
                urgencia = 'urgente';
            }
            
            try {
                const response = await fetch(`${API_URL}/api/bot/agendar-cita`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nombre_mascota: chatContext.pacienteNombre,
                        especie: chatContext.pacienteEspecie,
                        propietario: chatContext.tutorNombre,
                        telefono: chatContext.tutorTelefono,
                        sintomas: chatContext.sintomas.join(', ') || 'Consulta general',
                        urgencia: urgencia,
                        notas: `Cita agendada via chatbot. S√≠ntomas reportados: ${chatContext.sintomas.join(', ') || 'ninguno especificado'}`
                    })
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    let html = `<p>üéâ <strong>¬°Cita registrada exitosamente!</strong></p>`;
                    html += `<p>üìã <strong>Ticket:</strong> ${data.ticket || 'Pendiente'}</p>`;
                    html += `<p>üêæ <strong>Paciente:</strong> ${chatContext.pacienteNombre} (${chatContext.pacienteEspecie})</p>`;
                    html += `<p>üë§ <strong>Tutor:</strong> ${chatContext.tutorNombre}</p>`;
                    
                    if (esUrgente) {
                        html += `<p style="color: #ef4444; font-weight: 600;">üö® Se ha marcado como URGENTE</p>`;
                    }
                    
                    html += `<p>Nos pondremos en contacto contigo pronto al üì± ${chatContext.tutorTelefono}</p>`;
                    html += `<p>¬°Gracias por confiar en BetterDoctor! üè•</p>`;
                    
                    // Limpiar contexto
                    chatContext = {
                        lastIntent: null,
                        pacienteNombre: null,
                        pacienteEspecie: null,
                        tutorNombre: null,
                        tutorTelefono: null,
                        sintomas: [],
                        waitingFor: null
                    };
                    
                    return html;
                } else {
                    return `<p>‚ùå No se pudo registrar la cita: ${data.mensaje || 'Error desconocido'}</p>
                            <p>Por favor, intenta de nuevo o ll√°manos directamente.</p>`;
                }
            } catch (error) {
                console.error('Error al agendar cita:', error);
                return `<p>Hubo un problema al agendar la cita. Por favor intenta de nuevo.</p>`;
            }
        }

        // ========== LOGIN FUNCTIONS ==========
        function fillDemo(usuario, password) {
            document.getElementById('usuario').value = usuario;
            document.getElementById('password').value = password;
            document.getElementById('loginForm').dispatchEvent(new Event('submit'));
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const usuario = document.getElementById('usuario').value;
            const password = document.getElementById('password').value;
            
            const btn = document.querySelector('.btn-login');
            const originalText = btn.textContent;
            btn.textContent = 'Iniciando sesi√≥n...';
            btn.disabled = true;

            try {
                const response = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ usuario, password })
                });

                const data = await response.json();

                if (data.exito) {
                    localStorage.setItem('vetclinic_user', JSON.stringify(data.usuario));
                    
                    const rol = data.usuario.rol;
                    if (rol === 'admin' || rol === 'superadmin' || rol === 'administracion') {
                        window.location.href = 'superadmin.html';
                    } else if (rol === 'veterinario') {
                        window.location.href = 'index.html';
                    } else if (rol === 'recepcion' || rol === 'recepcionista') {
                        window.location.href = 'recepcion.html';
                    } else if (rol === 'inventario') {
                        window.location.href = 'inventario.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                } else {
                    alert(data.mensaje || 'Error al iniciar sesi√≥n');
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n. Intenta nuevamente.');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
